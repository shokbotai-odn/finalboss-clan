<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Final Boss - RuneLite Plugin Design Document</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 40px; line-height: 1.45; }
    h1 { border-bottom: 1px solid #ddd; padding-bottom: 6px; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
    .small { color: #666; font-size: 0.95em; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#eef2ff; margin-right: 6px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #111827; color: white; }
  </style>
</head>
<body>
  <h1>Final Boss - RuneLite Plugin Design Document</h1>
  <div class="small">Version 0.1 | Generated 2026-01-31</div>

  <h2>Executive Summary</h2>
  <p>Final Boss is a RuneLite Plugin Hub plugin for the Final Boss OSRS clan. It provides an in-game sidebar for:
  (1) showing the current Clan System channel roster (online members),
  (2) sharing member activity statuses (e.g., TOB, Bossing, Skilling, AFK) in near real time,
  (3) integrating with Discord for authentication, announcements, and direct pings, and
  (4) logging notable drops plus optional session-based loot splitting.</p>

  <h2>Goals</h2>
  <ul>
    <li>Show the new Clan System channel members immediately on login and keep the list updated using clan events (no heavy polling).</li><li>Let each user set their own status in the sidebar; sync statuses to other plugin users via a backend.</li><li>Authenticate users via Discord OAuth2; bind a Discord account to an in-game RSN using an in-game verification code to prevent spoofing.</li><li>Enable 'Ping in Discord' actions from the plugin (server -> bot DM), and optional Discord channel announcements for status changes and notable drops.</li><li>Log drops per user (opt-in by installing and authenticating) and support sessions for group tracking and split calculations.</li>
  </ul>
  <h2>Non-goals</h2>
  <ul>
    <li>No automation or gameplay actions (no input generation, no prayer switching, no click helpers).</li><li>No attempt to infer drops for users who are not running the plugin.</li><li>No reliance on scraping UI widgets; use official RuneLite APIs and events.</li>
  </ul>

  <h2>System Architecture</h2>
  <pre>Final Boss uses a 3-tier architecture:

1) RuneLite Plugin (client-side)
- Reads Clan System roster and relevant chat/game events from the RuneLite API.
- Renders a sidebar panel for member roster, status chips, filters, and session controls.
- Makes authenticated HTTPS calls (or WSS) to the backend.
- Never performs gameplay automation.

2) Backend API (server-side; AWS or DigitalOcean)
- Hosts Discord OAuth2 endpoints and issues an application session token (JWT or opaque token).
- Stores Discord ID <-> RSN mapping after in-game verification.
- Maintains current status state with TTL, drop logs, sessions, and split calculations.
- Pushes realtime updates to connected clients (WebSocket recommended) or supports short polling.

3) Discord Bot
- Posts announcements to configured channels (status changes, notable drops, session summaries).
- Sends DMs for plugin-initiated pings (subject to Discord user DM settings).
- Optional: provides slash commands (e.g., /status, /drops, /verify) that read from the backend.</pre>

  <h2>Component Responsibilities</h2>
  <table>
    <tr><th>Component</th><th>Responsibilities</th><th>Data In</th><th>Data Out</th></tr>
    <tr><td>RuneLite Plugin</td><td>UI panel, clan roster snapshot + deltas via events, capture user actions, detect eligible drop messages, session UX</td><td>Clan events, chat/game messages, backend updates</td><td>Status changes, drop logs, session actions, ping requests</td></tr><tr><td>Backend API</td><td>Auth, identity binding, persistence, realtime fan-out, business logic for sessions/splits, rate limiting</td><td>Plugin requests, bot events</td><td>Status snapshots/deltas, drop history, session summaries, bot instructions</td></tr><tr><td>Discord Bot</td><td>Announcements, DMs, optional slash commands</td><td>Backend instructions, (optional) slash command inputs</td><td>Discord messages/DMs, optional verification codes</td></tr>
  </table>

  <h2>Design Flows</h2>
  <h3>Flow A: Clan roster population</h3>
  <pre>1. Plugin starts. It attempts an initial refresh from client.getClanChannel().
2. If not yet logged in or channel not yet available, list is empty temporarily.
3. On GameStateChanged(LOGGED_IN) and/or ClanChannelChanged, plugin refreshes again.
4. The panel shows the full current member list immediately once the channel object is populated.
5. Subsequent joins/leaves are handled via ClanMemberJoined and ClanMemberLeft events.</pre>
  <h3>Event wiring</h3>
  <pre>@Override
protected void startUp()
{
    refreshMembers(); // may be empty before login
}

@Subscribe
public void onGameStateChanged(GameStateChanged e)
{
    if (e.getGameState() == GameState.LOGGED_IN)
    {
        refreshMembers();
    }
}

@Subscribe
public void onClanChannelChanged(ClanChannelChanged e)
{
    refreshMembers();
}

@Subscribe
public void onClanMemberJoined(ClanMemberJoined e) { refreshMembers(); }

@Subscribe
public void onClanMemberLeft(ClanMemberLeft e) { refreshMembers(); }

private void refreshMembers()
{
    ClanChannel channel = client.getClanChannel();
    List<ClanChannelMember> members =
        channel == null ? List.of() : channel.getMembers();

    SwingUtilities.invokeLater(() -> panel.setMembers(members));
}</pre>

  <h3>Flow B: Discord OAuth + RSN verification</h3>
  <pre>Goal: bind Discord identity to in-game RSN so that status updates cannot be spoofed.

1. User clicks "Login with Discord" in plugin.
2. Plugin opens browser to backend /auth/discord/start (Discord OAuth2 authorization code flow).
3. Backend completes OAuth and issues a plugin session token (JWT or opaque token).
4. Plugin stores token (RuneLite config) and marks user as authenticated.
5. Backend returns a short verification code (e.g., LINK-4F7K2) for RSN binding.
6. Plugin instructs user to type the code into clan chat.
7. Plugin listens to ChatMessage events for the user's own message containing the code.
8. Plugin calls backend /verify/complete with (token, rsn, code).
9. Backend marks mapping (discord_id <-> rsn) as verified.</pre>

  <h3>Flow C: Status set, sync, and Discord announcement</h3>
  <pre>1. User selects a status at the top of the panel (e.g., TOB).
2. Plugin sends PUT /v1/status with Authorization Bearer token and payload {status, note?, ttl}.
3. Backend validates token, verifies RSN mapping, rate-limits, and persists status with TTL.
4. Backend publishes a statusUpdate event to connected clients (WebSocket fan-out).
5. All clients update the matching member row in their sidebar.
6. Backend triggers Discord bot: announce status change in a configured channel.</pre>

  <h3>Flow D: Ping a member to DM them on Discord</h3>
  <pre>1. User clicks "Ping" on a member row.
2. Plugin calls POST /v1/ping with target RSN or target discord_id.
3. Backend validates authorization and applies anti-abuse limits.
4. Backend instructs bot to send a DM to target (if allowed by Discord privacy settings).
5. Plugin shows success/failure toast in RuneLite panel.</pre>

  <h3>Flow E: Drops, sessions, splits</h3>
  <pre>Drops:
- Plugin detects eligible loot messages (or specific raid/boss loot events if available).
- Plugin posts drop records to backend (item_id, qty, value estimate, source, timestamp, optional session_id).
- Backend stores the drop and optionally announces to Discord based on thresholds or allowlist.

Sessions and splits:
1. A leader starts a session and selects participants (manual selection is most accurate).
2. Backend creates session record and returns session_id.
3. Drops posted during an active session include session_id.
4. On session end, backend computes totals and per-person share, producing a settlement table.
5. Optional: bot posts a session summary to Discord.</pre>

  <h2>Backend API Sketch</h2>
  <pre>All endpoints require HTTPS. Use Bearer tokens for authentication.

Auth and verification:
- GET  /auth/discord/start
- GET  /auth/discord/callback
- POST /v1/verify/start
- POST /v1/verify/complete

Status:
- PUT  /v1/status
- POST /v1/status/batch   (query statuses for a roster)
- GET  /v1/status/me

Pings:
- POST /v1/ping

Drops:
- POST /v1/drops
- GET  /v1/drops?since=...

Sessions:
- POST /v1/sessions/start
- POST /v1/sessions/end
- GET  /v1/sessions/{id}/summary</pre>

  <h3>Event payload examples</h3>
  <pre>// status update (server -> clients)
{ "type": "statusUpdate", "rsn": "Alice", "status": "TOB", "note": "need 1", "expiresAt": "2026-01-31T20:00:00Z" }

// drop log (client -> server)
{ "rsn": "Alice", "itemId": 22325, "itemName": "Scythe of vitur", "qty": 1,
  "value": 1200000000, "source": "Theatre of Blood", "timestamp": "2026-01-31T18:00:00Z",
  "sessionId": "sess_9f3b..." }</pre>

  <h2>Data Models</h2>
  <h3>User</h3><ul><li>discord_id</li><li>rsn</li><li>verified</li><li>created_at</li><li>last_seen_at</li></ul><h3>Status</h3><ul><li>discord_id</li><li>status</li><li>note</li><li>updated_at</li><li>expires_at</li></ul><h3>Drop</h3><ul><li>drop_id</li><li>discord_id</li><li>rsn</li><li>item_id</li><li>item_name</li><li>qty</li><li>value</li><li>source</li><li>timestamp</li><li>session_id?</li></ul><h3>Session</h3><ul><li>session_id</li><li>leader_discord_id</li><li>activity</li><li>start_time</li><li>end_time</li><li>participants[]</li></ul>

  <h2>Security and Compliance Notes</h2>
  <ul>
    <li>RuneLite plugin remains informational: no automated inputs or gameplay actions.</li><li>Discord OAuth identifies the Discord account; RSN binding via in-game verification prevents spoofing.</li><li>Use HTTPS/WSS; store server secrets only on backend (Discord client secret, bot token).</li><li>Rate-limit ping and announcement endpoints to prevent abuse and avoid Discord rate limits.</li><li>Be transparent in Plugin Hub description about external connectivity and data sent (status, drops, session data).</li><li>Design to pass Plugin Hub review: minimal data collection, clear purpose, safe networking.</li>
  </ul>

  <h2>Suggested Code Layout</h2>
  <pre>finalboss/
  src/main/java/com/finalboss/runelite/
    FinalBossPlugin.java
    FinalBossConfig.java
    ui/
      FinalBossPanel.java
      MemberRow.java
    services/
      ClanRosterService.java
      StatusSyncService.java
      DropService.java
      SessionService.java
      ApiClient.java
    model/
      StatusRecord.java
      DropRecord.java
      SessionRecord.java
  src/main/resources/
    icon.png
    runelite-plugin.properties
</pre>

  <h2>References</h2>
  <ul>
    <li><a href="https://static.runelite.net/runelite-api/apidocs/net/runelite/api/Client.html">RuneLite API - Client: https://static.runelite.net/runelite-api/apidocs/net/runelite/api/Client.html</a></li><li><a href="https://static.runelite.net/runelite-api/apidocs/net/runelite/api/clan/ClanChannel.html">RuneLite API - ClanChannel: https://static.runelite.net/runelite-api/apidocs/net/runelite/api/clan/ClanChannel.html</a></li><li><a href="https://static.runelite.net/runelite-api/apidocs/net/runelite/api/events/package-summary.html">RuneLite API - Events package: https://static.runelite.net/runelite-api/apidocs/net/runelite/api/events/package-summary.html</a></li><li><a href="https://runelite.net/plugin-hub/">RuneLite Plugin Hub: https://runelite.net/plugin-hub/</a></li><li><a href="https://legal.jagex.com/docs/rules/macro-and-client-features-not-permitted">Jagex rules - macroing and client features: https://legal.jagex.com/docs/rules/macro-and-client-features-not-permitted</a></li><li><a href="https://discord.com/developers/docs/topics/oauth2">Discord OAuth2 documentation: https://discord.com/developers/docs/topics/oauth2</a></li><li><a href="https://github.com/runelite/runelite/wiki/Party">RuneLite Party wiki (optional session grouping inspiration): https://github.com/runelite/runelite/wiki/Party</a></li>
  </ul>
</body>
</html>
